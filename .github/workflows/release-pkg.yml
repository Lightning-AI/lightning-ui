name: Publish package

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  release:
    types: [published]

jobs:
  build-package:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: 16.x
      - name: Install env.
        run: |
          yarn install
          yarn husky install

      - name: Build UI
        run: yarn build
      - run: ls -lh build/
      - name: Pack UI
        working-directory: build/
        run: zip ../v0.0.0.zip -r .
      - run: ls -lh .

      - uses: actions/upload-artifact@v3
        with:
          name: build-${{ github.sha }}
          path: "*.zip"

  upload-package:
    runs-on: ubuntu-20.04
    needs: build-package
    if: startsWith(github.event.ref, 'refs/tags') || github.event_name == 'release'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v3
        with:
          name: build-${{ github.sha }}
      - run: ls -lh .
      - name: Upload to release
        uses: AButler/upload-release-assets@v2.0
        with:
          files: "*.zip"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  publish-package:
    runs-on: ubuntu-20.04
    needs: build-package
    # if: github.event_name == 'push' && github.ref == 'refs/heads/master' # FIXME
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v3
        with:
          name: build-${{ github.sha }}
      - run: ls -lh .

#      - name: Configure AWS credentials
#        uses: aws-actions/configure-aws-credentials@v4
#        with:
#          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY_ID }}
#          aws-region: us-east-1
#
#      - name: Upload to S3
#        run: aws s3 cp *.whl s3://lightning-packages/ --acl public-read
